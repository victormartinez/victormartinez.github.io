{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/blog/2021/2021-01-12-Usando_a_funcao_Postgres_array_agg_para_agregar_colunas_de_string/","result":{"data":{"site":{"siteMetadata":{"title":null,"siteUrl":"https://vcrmartinez.com","social":{"twitter":"vcrmartinez","github":"victormartinez","linkedin":"vcrmartinez","speakerdeck":"victormartinez"}}},"markdownRemark":{"id":"e79c65d2-9257-502c-a6df-822c7f79a222","excerpt":"Graças a @copquevictor eu aprendi uma função de agregação muito útil do Posgres: array_agg. Para entendê-las, vamos supor que você tenha que notificar…","html":"<p>Graças a <a href=\"https://twitter.com/copquevictor\">@copquevictor</a> eu aprendi uma função de agregação muito útil do Posgres: <strong>array_agg</strong>. Para entendê-las, vamos supor que você tenha que notificar interessados em relatórios e sua query fornece como saída a tabela abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token table\"><span class=\"token table-header-row\"><span class=\"token punctuation\">|</span><span class=\"token table-header important\"> Report    </span><span class=\"token punctuation\">|</span><span class=\"token table-header important\"> Email                  </span><span class=\"token punctuation\">|</span>\n</span><span class=\"token table-line\"><span class=\"token punctuation\">|</span> <span class=\"token punctuation\">---------</span> <span class=\"token punctuation\">|</span> <span class=\"token punctuation\">----------------------</span> <span class=\"token punctuation\">|</span>\n</span><span class=\"token table-data-rows\"><span class=\"token punctuation\">|</span><span class=\"token table-data\"> Report #1 </span><span class=\"token punctuation\">|</span><span class=\"token table-data\"> johndoe@gmail.com      </span><span class=\"token punctuation\">|</span>\n<span class=\"token punctuation\">|</span><span class=\"token table-data\"> Report #1 </span><span class=\"token punctuation\">|</span><span class=\"token table-data\"> jack@gmail.com         </span><span class=\"token punctuation\">|</span>\n<span class=\"token punctuation\">|</span><span class=\"token table-data\"> Report #2 </span><span class=\"token punctuation\">|</span><span class=\"token table-data\"> contact@lisadesign.com </span><span class=\"token punctuation\">|</span>\n<span class=\"token punctuation\">|</span><span class=\"token table-data\"> Report #3 </span><span class=\"token punctuation\">|</span><span class=\"token table-data\"> harry@hogwarts.com     </span><span class=\"token punctuation\">|</span>\n<span class=\"token punctuation\">|</span><span class=\"token table-data\"> Report #3 </span><span class=\"token punctuation\">|</span><span class=\"token table-data\"> anderson@gmail.com     </span><span class=\"token punctuation\">|</span></span></span></code></pre></div>\n<p>Como você pode ver, nós temos uma relação Um-para-muitos: um relatório é de interesse de um ou mais emails. Você pode notificar os emails por meio (i) da iteração dos registros (um por um) <strong>OU</strong> (ii) você pode agrupar os emails por relatório. Para o segundo caso, não seria legal obter os resultados abaixo?</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">| Report    | Email                                    |\n|-----------|------------------------------------------|\n| Report #1 | [johndoe@gmail.com, jack@gmail.com]      |\n| Report #2 | [contact@lisadesign.com]                 |\n| Report #3 | [harry@hogwarts.com, anderson@gmail.com] |</code></pre></div>\n<p>Graças a <strong><a href=\"https://www.postgresql.org/docs/13/functions-aggregate.html\">array_agg</a></strong> isso pode ser realizado. Para nossa tabela fictícia, a query seria algo parecido com a query abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> reports<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> array_agg<span class=\"token punctuation\">(</span>stakeholders<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> reports\n<span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> stakeholders <span class=\"token keyword\">ON</span> reports<span class=\"token punctuation\">.</span>id <span class=\"token operator\">=</span> stakeholders<span class=\"token punctuation\">.</span>report_id\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> reports<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span></code></pre></div>\n<p>Preste atenção que você <strong>tem que fornecer a cláusula GROUP BY</strong> a fim de agregar os emails.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> sqlalchemy <span class=\"token keyword\">import</span> String\n<span class=\"token keyword\">from</span> sqlalchemy<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span>functions <span class=\"token keyword\">import</span> array_agg\n<span class=\"token keyword\">from</span> sqlalchemy<span class=\"token punctuation\">.</span>dialects<span class=\"token punctuation\">.</span>postgresql <span class=\"token keyword\">import</span> ARRAY\n\n<span class=\"token keyword\">from</span> models <span class=\"token keyword\">import</span> Stakeholder<span class=\"token punctuation\">,</span> Report\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    emails_agg <span class=\"token operator\">=</span> array_agg<span class=\"token punctuation\">(</span>Stakeholder<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span> type_<span class=\"token operator\">=</span>ARRAY<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"emails\"</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n        db<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>query<span class=\"token punctuation\">(</span>Report<span class=\"token punctuation\">,</span> emails_agg<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>Stakeholder<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span>group_by<span class=\"token punctuation\">(</span>Report<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>Bem útil, não acha?</p>\n<h3>Referências:</h3>\n<ul>\n<li><a href=\"https://stackoverflow.com/questions/23261944/sqlalchemy-postgresql-and-array-agg-how-to-select-items-from-array-agg\">Stackoverflow: SQLAlchemy, PostgreSQL and array<em>agg: How to select items from array</em>agg?</a></li>\n</ul>","frontmatter":{"title":"Usando a função Postgres::array_agg para agregar colunas de string","date":"2021-01-12T00:00:00.000Z","description":null,"tags":["postgres","array","agg","function","sqlalchemy"],"rating":null,"image_url":"https://unsplash.com/photos/QJbyG6O0ick","image_author":"Nam Anh","image":{"publicURL":"/static/22617a1f62ae5b764473b8360f53c665/featured.png"}},"fields":{"slug":"/2021/2021-01-12-Usando_a_funcao_Postgres_array_agg_para_agregar_colunas_de_string/"},"timeToRead":1}},"pageContext":{"id":"e79c65d2-9257-502c-a6df-822c7f79a222","language":"en","intl":{"language":"en","languages":["en","pt"],"messages":{"of":"of","or":"or","Next":"Next","Previous":"Previous","reading":"reading","Comments":"Comments","Featured_image_credits":"Featured image credits","Not_Found":"Not Found","Not_Found_Text":"The page you are looking for might have been removed, had its name changed or is temporarily unavailable.","Not_Found_Nav":"You can go to","Warning_deprecated":"Attention: this post was written some time ago and may not be valid anymore, ok?"},"routed":true,"originalPath":"/blog/2021/2021-01-12-Usando_a_funcao_Postgres_array_agg_para_agregar_colunas_de_string/","redirect":true,"defaultLanguage":"en"}}},"staticQueryHashes":["4061151221"]}