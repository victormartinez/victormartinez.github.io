{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/blog/2019/2019-05-18-Creating_bulletproof_command_line_scripts/","result":{"data":{"site":{"siteMetadata":{"title":null,"siteUrl":"https://vcrmartinez.com","social":{"twitter":"vcrmartinez","github":"victormartinez","linkedin":"vcrmartinez","speakerdeck":"victormartinez"}}},"markdownRemark":{"id":"a493d1fe-37e8-5a1c-86de-074a1d456ac4","excerpt":"The life of a backend developer involves creating some scripts to be executed in the production environment. For instance, you might need to update many records…","html":"<p>The life of a backend developer involves creating some scripts to be executed in the production environment. For instance, you might need to update many records at once, trigger events or fix a specific bug. <em>What do they have in common?</em> If not designed properly, they can cause a very bad side-effect on your application, ruin the user experience, etc.</p>\n<p>In the real-world scenario some changes are ~pratically~ impossible to revert:</p>\n<ol>\n<li>Triggering emails / notifications / messages / SMSs to customers</li>\n<li>Accidentally giving an offer to a user</li>\n<li>Updating records without a backup</li>\n</ol>\n<p>As developers we need not only to double check our scripts but also do our best to minimize/avoid possible side-effects (especially if something unexpected happen). Some weeks ago, during a pair programming session, <a href=\"https://etandel.xyz\">Elias</a> and I created a critical <a href=\"https://docs.djangoproject.com/en/2.2/howto/custom-management-commands/\">Django command</a> responsible for changing records on many tables according to a business logic. As we dove into the instrinsic parts of the script, we realised how dangerous that could be and took some precautions shared in this post.</p>\n<h2>Progress Bars are awesome!</h2>\n<p>Running a script that takes too much time to complete is nerve-racking. You get confused because you do not know what is happening: (i) is it still running? (ii) is the connection down? That’s why a sense of progress is important. If you are a python programmer some projects like <a href=\"https://github.com/tqdm/tqdm\">tqdm</a> and <a href=\"https://github.com/kennethreitz/clint\">clint</a> can help you by providing ways to create progress bars. Anyway, if that is too much effort or your programming language does not help you with that, a simple <code class=\"language-text\">&lt;accomplished&gt;/&lt;total&gt;</code> indicator is a good start, at least.</p>\n<h2>Logging</h2>\n<p>After running a script, things happen:</p>\n<ol>\n<li>You are not sure what was done; Some days later, how do you recall?</li>\n<li>You won’t be 100% sure about the records that were updated;</li>\n<li>Any rollback will require an specific backup;</li>\n</ol>\n<p>Besides, think of the scenario in which your script has an unexpected bug or the records you update are not consistent aligned to the business logic. <em>How easy is it to revert the side effects?</em></p>\n<p>All the pain aforementioned can be attenuated if you simply log the changes. You can create a simple file that stores: (i) the id of the records you updated; (ii) the previous column value; (iii) the new value. That way, if something unexpected happens you can easily parse the log, obtain the records you changed and set the old values back without having to load a backup.</p>\n<h2>Self-check</h2>\n<p>What if your script could check for inconsistencies during the execution? Just before the completion, it could parse the log and check whether the new records are consistent to the business logic.</p>\n<p>Let’s suppose, for instance, you need to multiply the balance of several users by a factor. As you are cautious, your script produces the following log:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">id;old;new\n10987;10;100\n98011;5;50\n87652;3;35</code></pre></div>\n<p>The last record is not correct because the new balance exceeds by 5 the expected value (30). In that case, an Exception can be thrown in order to rollback all the changes.</p>\n<h2>Rollback</h2>\n<p>Especially when handling database records, you must ensure that an all-or-nothing policy will be followed: either all changes are persisted or nothing is done. Use a database transaction to accomplish that because in the event of any error the rollback will be performed.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@transaction<span class=\"token punctuation\">.</span>atomic</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token operator\">&lt;</span>your_code_goes_here<span class=\"token operator\">></span></code></pre></div>\n<h2>Dry-run</h2>\n<p>As often as possible provide a <code class=\"language-text\">dry-run</code> option. That way the changes are not commited and it is possible to check for errors in the execution time. If you use Django framework, for example, your command can rollback all the changes if <code class=\"language-text\">dry-run</code> is passed as argument:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@transaction<span class=\"token punctuation\">.</span>atomic</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    dry_run <span class=\"token operator\">=</span> kwargs<span class=\"token punctuation\">[</span><span class=\"token string\">'dry_run'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> dry_run<span class=\"token punctuation\">:</span>\n        transaction<span class=\"token punctuation\">.</span>set_rollback<span class=\"token punctuation\">(</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Tmux</h2>\n<p>What if your connection gets lost during the execution? That can be really bad, huh? That’s why it is recommended to use a Terminal multiplexer like tmux (check this <a href=\"https://www.hamvocke.com/blog/a-quick-and-easy-guide-to-tmux/\">tutorial</a>). It is really useful because you can start long-running tasks on your remote server and keep them running even though your connection is lost.</p>\n<h2>Code Review</h2>\n<p>Every code going to production should be reviewed by other programmer. Scripts are no exception. Period.</p>","frontmatter":{"title":"Creating bulletproof command-line scripts","date":"2019-05-18T00:00:00.000Z","description":null,"tags":["command","line","scripts"],"rating":null,"image_url":"https://unsplash.com/photos/ieic5Tq8YMk","image_author":"Chris Ried"},"fields":{"slug":"/2019/2019-05-18-Creating_bulletproof_command_line_scripts/"},"timeToRead":3}},"pageContext":{"id":"a493d1fe-37e8-5a1c-86de-074a1d456ac4","language":"en","intl":{"language":"en","languages":["en","pt"],"messages":{"of":"of","or":"or","Next":"Next","Previous":"Previous","reading":"reading","Comments":"Comments","Featured_image_credits":"Featured image credits","Not_Found":"Not Found","Not_Found_Text":"The page you are looking for might have been removed, had its name changed or is temporarily unavailable.","Not_Found_Nav":"You can go to","Warning_deprecated":"Attention: this post was written some time ago and may not be valid anymore, ok?"},"routed":true,"originalPath":"/blog/2019/2019-05-18-Creating_bulletproof_command_line_scripts/","redirect":true,"defaultLanguage":"en"}}},"staticQueryHashes":["2841359383"]}