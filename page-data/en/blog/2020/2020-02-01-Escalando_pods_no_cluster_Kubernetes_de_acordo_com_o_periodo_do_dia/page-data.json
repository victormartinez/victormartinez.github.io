{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/blog/2020/2020-02-01-Escalando_pods_no_cluster_Kubernetes_de_acordo_com_o_periodo_do_dia/","result":{"data":{"site":{"siteMetadata":{"title":null,"siteUrl":"https://vcrmartinez.com","social":{"twitter":"vcrmartinez","github":"victormartinez","linkedin":"vcrmartinez","speakerdeck":"victormartinez"}}},"markdownRemark":{"id":"40903d48-376e-5547-b759-d500907dffc1","excerpt":"Existem empresas que dependem fortemente de períodos específicos do dia para obter lucro. Empresas de food service, por exemplo, tendem a ter uma operação…","html":"<p>Existem empresas que dependem fortemente de períodos específicos do dia para obter lucro. Empresas de <em>food service</em>, por exemplo, tendem a ter uma operação aquecida ao meio-dia e o comportamento oposto nos demais períodos do dia. Em relação à infraestrutura, o fenômeno é particularmente interessante porque em um determinado período do dia a aplicação recebe uma quantidade impressionante de solicitações e o cluster deve ser capaz de escalar muito rápido. Uma escala lenta traria erros e lentidão para o cliente e, então, resultaria em aumento do churn. O gráfico abaixo exemplifica o cenário.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 851px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.41666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAACdklEQVQoz2Pg5ZNS5RdUUOHlk5Tn5BJkYQACfj5xEMWwKSSAAQaWBwWD6cj6w2A6vO4wV2TjcQM14yABLm5xMTFpAzawBC+/tCy/oLyqgJC8FD+/FNhABi4Jhj2hvmDmrlA/1nXBgbwg9tKgEIYtawrA4huX5fJvWVnoYmtjIc7GIS0rLqnGzYAM+PgkRfj4pVhBbHdVDYb5gWGMIPaq4GC7tcFBYcsDg8FyG+L8weq3Jnnz70z1d7ZS15Nk45WVERFREoS5EKwRaJgozMApHh4QVwQHigFdZQ50oTTQUH2Q2NrAILD6KRrBjDO1I9l1JQ2YuYTkWYRFVJkYoAYxoBu40M8XrAloiCHQpYpnwj3ZgWxbkBgoKJbaBDBgAwLCStgNTLILAoutDAp2m+IfyQH2anCgPZDPBw7LkFCGGgZHhn1tYQy75oUwbprpz5gWYcmA4UJgTLP+//8fzF8fEiS3JCjEEmb7puAAmfXBgeYg9rTkcqbJ8ycyIrvuwLIohgNLI4FJREAabqCymgU7TMGqwECPif4R/CB2u6snI9SVDjs97MRgap7ttGE9vjpC5/S6MFm4yTw8omAaaLAoTKypZr7JvJgMI/Qw+u+rwja5sN0tee4DyZ75m8UPrUz0PrEmRuPyliizS5sjjcGK5NUswLSQiIJkUNYkl5jyxf6h+TMdGBhEOYT5Jbj4BGS4gEHBJSOhAkpnbFq++ULhRQvsU8one6YkR8Fcxryk10dWUUGVg0FYTBmSfPgkOdX0XaRUdB0lQElbgEdUkF9ARggYFGAMlBcUFZEXBqZ8UDBwATEnKKTUVFSFREVlZBhZxF34BOTkAfm3kSrHsjYIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"Daypart behavior\"\n        title=\"Daypart behavior\"\n        data-src=\"/static/1d3e515b8ddc6f09df6bedcf7558a0ce/0fcea/daypart_behavior_chart.png\"\n        data-srcset=\"/static/1d3e515b8ddc6f09df6bedcf7558a0ce/8ff5a/daypart_behavior_chart.png 240w,\n/static/1d3e515b8ddc6f09df6bedcf7558a0ce/e85cb/daypart_behavior_chart.png 480w,\n/static/1d3e515b8ddc6f09df6bedcf7558a0ce/0fcea/daypart_behavior_chart.png 851w\"\n        sizes=\"(max-width: 851px) 100vw, 851px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Você pode se perguntar se o problema pode ser resolvido com um mecanismo simples de escalonamento automático. Bem, isso funciona para ~95% dos clientes, mas ~5% terão problemas. A velocidade de expansão da infraestrutura pode não ser rápida o suficiente para lidar com a avalanche de solicitações. Felizmente, uma boa solução (até agora) é dimensionar as máquinas de antemão. Se você tiver um cluster Kubernetes, a solução é mais fácil do que você pensa: uma combinação de escalonamento automático horizontal de pod e CronJobs resolve o problema.</p>\n<p>Um agradecimento especial a <a href=\"https://www.linkedin.com/in/robsonpeixoto/\">Robson Peixoto</a> por me guiar nessa tarefa.</p>\n<h2>Visao geral</h2>\n<p>A ideia é criar um CronJob com as permissões corretas para editar as propriedades de escalonamento automático e, portanto, aumentar ou diminuir o número de pods disponíveis. A imagem abaixo ilustra o cenário.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 372px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 110.83333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsSAAALEgHS3X78AAAFMUlEQVQ4y41UW2wUVRgeCOHaAilQukQT0cSgoJj44IP6xgNplfjog/qgEiMXRWMsRgkVTdVEKia8+mq5GWFbpZdtafc2e5u9zv2yM7OzO7uzbdndrtTuzuz8ntmCVuCBk3wzX/7z58uc//vmYNh/a92Gzduf2bhl53ObO7v3rqpjnVtdHZ2dro2ra+s3bd+7qWPnCxs692xaXceewF5cCxhgT2IH1+/q2vdsT9eB/T3dB566u73WeXR1Pd6xZUv3ZocfxX5Y88b6D9bu2rZv7+4dB/bve+xQp1N/GzvT7sW4LBuQSnxIKgh4YSE3m68oM/pc3muUjGCpVMrwvPij0zd2c+JVKS+ExSKPSxqPa/Oqt1DJzcgFMSjqfCBbFMlbM8F3MakkwFTKA0yRBLZIt3mprkNjuQHOymbVKUcwQSRe50oMeJKToFREiMsEBBg/5GoyeOKToNazEMSJQYxT2Yaf9LYYjbRIJW0FKL+VKytWtVptNJtNkCRlxBGMRqK9pJy2A5TPEoucGRcIK8KFHW4FMr6GclsCnz96FhM13hTmGBCLrJ0ti8CVaUCCdq1as1qtliP4hyMY9ON9Mtrny7Qt6ZwtlXkQDAakIo9qjDm3XITZ2fAARioZ81fPMISFkB1igjA8OQxoDA8IJhPJvggXguGJYZsupG1PbBLcvhvA6iRcnrxkprQE4KHEACYprClkCZA1xpaKAmqgIT+n2dX7BEPBUB8yBGg9g/p4m0N9bJFqfyFdyJjlZX3lCxcuXmws7tjZqr/3vlW7s2TVKlWrilCpVBqm2Z7haFsQD/cyGmWHONzidcbKqCkrJkbbM4zwoZUZ+tAMl74bhHkMg+bhw2AjVy3LhJZlQbO54rKs5Noup5KpI/dc1hZlILIxCLB+yNcVmCDGQVtSIBRODGLSmMdb/v48nr90DZeVAi5nc22guPgR0vE4OeQIjo7efJkSaDwtZHCSp4KkQOEZgUS8XfPTEp0eGZk+ihEs9Xuqoo8kNcmdZtLujJBxkwzlFnjpOgq1hyBSZxzBq1d+e4lkSTclUu4Mg3p4yo1EESed93VKoKZGRj1vYoohQZCeBdGJwDyPjuGDuTsGmE1z5cjyypHjRPxIdkEAP+sFDYWZLKQhlo1AoZ4DP+0FfVlDLscHMVohG2ORP1spOW7FxZg1ERu3ZENCxtQazVWmEFGiNyHE7PHomMXplBWkAtZs6hbitDURGWs4+fUHYmexbEEy84sqKGXJ1uYVyFVlKDwkNgFfoE9bUNGvpthyCfVWEK8ooJQk0KqKWbUWYGYmhIItp83L05cgwuN2mMPhyvSVhwY7EU/0Rfkw2r9sUyjY0/EpGA26gdEzcG36qpkuOMGOD2BCjjNjYgT4AmOzGg2EGAWtrD4gGAlF+rg8A4QUsdHtZGeUFKTkRDvYhBgx9b808PoiA5hhGM16fdFGQW6hC6FVq9VaDkdomqb57wzxYKiX11lIqvGWoLMWW6BamVyqhQRbKTXRdMbm9SLB+fl5WF5ehqWlpf+hXq/fc3n87r/8WlpNwgjuBnGORcnww1TCA9kFHtz+GyDcZp1gf4Opaq5QLBplXS8Z96FYLJaWKIofdgRvTc8eYhW2TCmkwamcwSiMQau0wSmcQcqkzmvc3xMTvn7s+Mmvu48dP+c6duJcD4JrFXo+PD6w59PPftq+Zk1nx/MHX9n27Ve/dH9+4ryr/9SFnv6Ph1z9J4dcpz/52XX6o6GeL05d2PPWO19uxR5l7e55egOGdax7lN5/ALaBtuORmw4BAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"Diagram illustrating before and after scenarios\"\n        title=\"Diagram illustrating before and after scenarios\"\n        data-src=\"/static/327602690cb30d205aea37e575e74666/98b6e/before_after_cronscale.png\"\n        data-srcset=\"/static/327602690cb30d205aea37e575e74666/8ff5a/before_after_cronscale.png 240w,\n/static/327602690cb30d205aea37e575e74666/98b6e/before_after_cronscale.png 372w\"\n        sizes=\"(max-width: 372px) 100vw, 372px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Embora a imagem ilustre um processo de aumento de pods, o oposto também pode ser realizado: você pode querer diminuir o número de pods durante a madrugada, por exemplo, para diminuir o número de nós e, portanto, o custo de infraestrutura.</p>\n<h2>Horizontal Pod Autoscaler</h2>\n<p>Como o CronJob vai <strong>editar</strong> as propriedades de escalonamento automático, precisamos de um Horizontal Pod Autoscaler disponível. O código yaml abaixo ilustra o escalonamento de uma aplicação back-end localizada dentro do namespace <code class=\"language-text\">backend</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> HorizontalPodAutoscaler\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> autoscaling/v2beta1\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>autoscale\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> backend\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">scaleTargetRef</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>web\n  <span class=\"token key atrule\">minReplicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n  <span class=\"token key atrule\">maxReplicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">50</span>\n  <span class=\"token key atrule\">metrics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Resource\n      <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cpu\n        <span class=\"token key atrule\">targetAverageValue</span><span class=\"token punctuation\">:</span> 120m</code></pre></div>\n<h2>Permissões</h2>\n<p>Agora é hora de configurar as permissões do CronJob. Para fazer isso, usamos o RBAC para conceder acesso à API Kubernetes e garantir que ele tenha apenas permissão para acessar o recurso de escalonamento automático. Eu uso o termo <code class=\"language-text\">cronscale</code> para identificar o processo de dimensionamento de acordo com o CronJob.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>cronscale\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> backend\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>cronscale\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> backend\n<span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">apiGroups</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"autoscaling\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"horizontalpodautoscalers\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">verbs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"list\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"patch\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRoleBinding\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>cronscale\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> backend\n<span class=\"token key atrule\">roleRef</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">apiGroup</span><span class=\"token punctuation\">:</span> rbac.authorization.k8s.io\n  <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ClusterRole\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>cronscale\n<span class=\"token key atrule\">subjects</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ServiceAccount\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>cronscale\n    <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> backend</code></pre></div>\n<h2>Aplicação</h2>\n<p>Antes de criar o CronJob, precisamos criar a imagem / aplicação responsável por atualizar as propriedades de escalonamento automático. Para isso, sugiro usar o <a href=\"https://github.com/kubernetes-client/python\">cliente python</a>. O snippet de código abaixo é apenas um exemplo de implementação que você pode usar. Fique à vontade para mudar de acordo com suas necessidades.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># settings.py</span>\n\nPROJECTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"backend\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"HPA\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"NAMESPACE\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"backend\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"NAME\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"backend-autoscale\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"TARGET\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"backend-web\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Em vez de manter strings hardcoded no código, utilizo um arquivo <code class=\"language-text\">settings</code> para armazenar as propriedades relacionadas a cada projeto …</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># hpa.py</span>\n<span class=\"token keyword\">from</span> kubernetes <span class=\"token keyword\">import</span> config\n\nconfig<span class=\"token punctuation\">.</span>load_incluster_config<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">from</span> kubernetes <span class=\"token keyword\">import</span> client\n<span class=\"token keyword\">from</span> kubernetes<span class=\"token punctuation\">.</span>client<span class=\"token punctuation\">.</span>models<span class=\"token punctuation\">.</span>v2beta1_horizontal_pod_autoscaler <span class=\"token keyword\">import</span> <span class=\"token punctuation\">(</span>\n    V2beta1HorizontalPodAutoscaler<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">import</span> settings\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">scale</span><span class=\"token punctuation\">(</span>\n    project_name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> min_replicas<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">,</span> max_replicas<span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> V2beta1HorizontalPodAutoscaler<span class=\"token punctuation\">:</span>\n    config <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>PROJECTS<span class=\"token punctuation\">[</span>project_name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"HPA\"</span><span class=\"token punctuation\">]</span>\n\n    api_client <span class=\"token operator\">=</span> client<span class=\"token punctuation\">.</span>AutoscalingV2beta1Api<span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">.</span>ApiClient<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    v2beta1_hpa <span class=\"token operator\">=</span> api_client<span class=\"token punctuation\">.</span>read_namespaced_horizontal_pod_autoscaler<span class=\"token punctuation\">(</span>\n        config<span class=\"token punctuation\">[</span><span class=\"token string\">\"NAME\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">\"NAMESPACE\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span>\n    v2beta1_hpa<span class=\"token punctuation\">.</span>spec<span class=\"token punctuation\">.</span>min_replicas <span class=\"token operator\">=</span> min_replicas\n    v2beta1_hpa<span class=\"token punctuation\">.</span>spec<span class=\"token punctuation\">.</span>max_replicas <span class=\"token operator\">=</span> max_replicas\n    v2beta1_hpa<span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n\n    <span class=\"token keyword\">return</span> api_client<span class=\"token punctuation\">.</span>patch_namespaced_horizontal_pod_autoscaler<span class=\"token punctuation\">(</span>\n        config<span class=\"token punctuation\">[</span><span class=\"token string\">\"NAME\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">[</span><span class=\"token string\">\"NAMESPACE\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> v2beta1_hpa\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<p>… então eu posso passar como parâmetro o nome do projeto (<code class=\"language-text\">backend</code>) para a função <code class=\"language-text\">scale</code> e ela saberá onde obter as propriedades.</p>\n<h2>CronJob</h2>\n<p>Agora que temos as permissões, é hora de criar o CronJob. Preste atenção à 12ª linha, pois ela permite que o kubernetes execute o pod com as permissões que configuramos anteriormente.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> batch/v9beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> CronJob\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cronscale<span class=\"token punctuation\">-</span>midday\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> backend\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">schedule</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"&lt;YOUR-CRON-GOES-HERE>\"</span> <span class=\"token comment\"># UTC</span>\n  <span class=\"token key atrule\">jobTemplate</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">serviceAccountName</span><span class=\"token punctuation\">:</span> backend<span class=\"token punctuation\">-</span>cronscale\n          <span class=\"token key atrule\">restartPolicy</span><span class=\"token punctuation\">:</span> Never\n          <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n            <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> job\n              <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> &lt;YOUR<span class=\"token punctuation\">-</span>IMAGE<span class=\"token punctuation\">-</span>AND<span class=\"token punctuation\">-</span>VERSION<span class=\"token punctuation\">-</span>GOES<span class=\"token punctuation\">-</span>HERE<span class=\"token punctuation\">></span>\n              <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> IfNotPresent\n              <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>&lt;YOUR<span class=\"token punctuation\">-</span>COMMAND<span class=\"token punctuation\">-</span>GOES<span class=\"token punctuation\">-</span>HERE<span class=\"token punctuation\">></span><span class=\"token punctuation\">]</span></code></pre></div>\n<h2>Considerações Importantes</h2>\n<p>It is important to be carefull regarding some points:</p>\n<ol>\n<li><strong>UTC vs LocalTime:</strong> Configure the Dockerfile to use UTC time and consider it in the <code class=\"language-text\">schedule</code> property.</li>\n<li><strong>Click:</strong> You can wrap the python code with <a href=\"https://click.palletsprojects.com/en/7.x/\">Click</a> to create an easy to use command line interface.</li>\n<li><strong>Configmaps:</strong> The settings module use hardcoded values but it could easily take the values from a ConfigMap.</li>\n<li><strong>Non-root user:</strong> Do not use root user for the Dockerfile. You can take the Dockerfile below as a starting point:</li>\n</ol>\n<p>É importante ter cuidado com alguns pontos:</p>\n<ol>\n<li><strong>UTC vs LocalTime:</strong> Configure o Dockerfile para usar o horário UTC e considere-o na propriedade <code class=\"language-text\">schedule</code>.</li>\n<li><strong>Click:</strong> Você pode usar o <a href=\"https://click.palletsprojects.com/en/7.x/\">Click</a> para criar uma CLI fácil de usar.</li>\n<li><strong>Configmaps</strong> O arquivo <em>settings</em> usa valores fixos (hardcoded), mas pode utilizar Configmaps se não gostar da abordagem.</li>\n<li><strong>Usuário não root:</strong> Não use usuário root para o Dockerfile. Você pode usar o Dockerfile abaixo como ponto de partida:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token keyword\">FROM</span> python<span class=\"token punctuation\">:</span>3.7\n\n<span class=\"token keyword\">ENV</span> PYTHONUNBUFFERED=1\n\n<span class=\"token keyword\">ENV</span> TZ=UTC\n\n<span class=\"token keyword\">RUN</span> useradd <span class=\"token punctuation\">-</span>ms /bin/bash app\n\n<span class=\"token keyword\">USER</span> app\n\n<span class=\"token keyword\">WORKDIR</span> /home/app\n\n<span class=\"token keyword\">ADD</span> . /home/app\n\n<span class=\"token keyword\">RUN</span> pip install <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>upgrade pip &amp;&amp; pip install <span class=\"token punctuation\">-</span>r requirements.txt</code></pre></div>","frontmatter":{"title":"Escalando pods no cluster Kubernetes de acordo com o período do dia","date":"2020-02-01T00:00:00","description":null,"tags":["kubernetes","devops","k8s","autoscaling","hpa"],"rating":null,"image_url":"https://unsplash.com/photos/G9gHtroxnaI","image_author":"Frank Eiffert","image":{"publicURL":"/static/340a9ed3868769182d0d0801ffb618a5/featured.jpeg"}},"fields":{"slug":"/2020/2020-02-01-Escalando_pods_no_cluster_Kubernetes_de_acordo_com_o_periodo_do_dia/"},"timeToRead":4}},"pageContext":{"id":"40903d48-376e-5547-b759-d500907dffc1","language":"en","intl":{"language":"en","languages":["en","pt"],"messages":{"of":"of","or":"or","Next":"Next","Previous":"Previous","reading":"reading","Comments":"Comments","Featured_image_credits":"Featured image credits","Not_Found":"Not Found","Not_Found_Text":"The page you are looking for might have been removed, had its name changed or is temporarily unavailable.","Not_Found_Nav":"You can go to","Warning_deprecated":"Attention: this post was written some time ago and may not be valid anymore, ok?"},"routed":true,"originalPath":"/blog/2020/2020-02-01-Escalando_pods_no_cluster_Kubernetes_de_acordo_com_o_periodo_do_dia/","redirect":true,"defaultLanguage":"en"}}},"staticQueryHashes":["4061151221"]}