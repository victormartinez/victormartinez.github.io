{"componentChunkName":"component---src-templates-blog-post-js","path":"/pt/blog/2020/2020-01-16-Kubernetes_meu_cheat_sheet_pessoal/","result":{"data":{"site":{"siteMetadata":{"title":null,"siteUrl":"https://vcrmartinez.com","social":{"twitter":"vcrmartinez","github":"victormartinez","linkedin":"vcrmartinez","speakerdeck":"victormartinez"}}},"markdownRemark":{"id":"78d12748-899b-5ed5-8e70-b502f28f8b27","excerpt":"Se sua infraestrutura é composta por um cluster Kubernetes, você provavelmente tem um conjunto de comandos em mãos para tarefas comuns. A documentação do Google…","html":"<p>Se sua infraestrutura é composta por um cluster Kubernetes, você provavelmente tem um conjunto de comandos em mãos para tarefas comuns. A documentação do Google fornece um <a href=\"https://kubernetes.io/docs/reference/kubectl/cheatsheet/\">cheat sheet</a> útil que você deve dar uma olhada. Porém, neste post irei compartilhar alguns comandos que uso / tenho usado.</p>\n<h2>Comandos Gcloud</h2>\n<ul>\n<li>Obter credenciais: <code class=\"language-text\">gcloud container clusters get-credentials &lt;CLUSTER-NAME&gt; --zone &lt;ZONE&gt; --project &lt;PROJECT-ID&gt;</code></li>\n<li>Obter imagens que você fez upload: <code class=\"language-text\">gcloud container images list-tags gcr.io/&lt;project-id&gt;/&lt;image-name&gt; [--limit &lt;N&gt;]</code></li>\n<li>Obter a última imagem do registry: <code class=\"language-text\">gcloud container images list-tags gcr.io/&lt;project-id&gt;/&lt;image-name&gt; --limit 1 | tail -1 | awk &#39;{print $2}&#39;</code></li>\n</ul>\n<h2>Comandos Básicos</h2>\n<ul>\n<li>Verifique o contexto atual (melhor usar <a href=\"https://github.com/ahmetb/kubectx/\">kubectx</a>): <code class=\"language-text\">kubectl config current-context</code></li>\n<li>Você iniciou algum job? Melhor verificar: <code class=\"language-text\">kubectl get jobs,pods [-n &lt;NAMESPACE&gt; | --all-namespaces | -o wide]</code></li>\n<li>Quantos nós no cluster? <code class=\"language-text\">kubectl get nodes [-o wide]</code></li>\n<li>Liste os recursos: <code class=\"language-text\">kubectl get all,svc,deploy,configmaps,secrets,ingress,hpa [-n &lt;NAMESPACE&gt; | --all-namespaces]</code></li>\n<li>Quais namespaces seu cluster tem? <code class=\"language-text\">kubectl get namespaces</code></li>\n<li>Exporte um deployment (útil para debugar o yaml): <code class=\"language-text\">kubectl get deploy &lt;NAME&gt; -o yaml --export</code></li>\n<li>Obtenha o Managed Certificate: <code class=\"language-text\">kubectl describe managedcertificate [-n &lt;NAMESPACE&gt;]</code></li>\n<li>Faça encaminhamento de porta: <code class=\"language-text\">kubectl port-forward [-n &lt;NAMESPACE&gt;] svc/&lt;SERVICE-NAME&gt; &lt;LOCAL-PORT&gt;:&lt;REMOTE-PORT&gt;</code></li>\n<li>Suspenda um CronJob: <code class=\"language-text\">kubectl patch cronjobs &lt;cronjob-name&gt; -p &#39;{&quot;spec&quot; : {&quot;suspend&quot; : true }}&#39; [-n &lt;NAMESPACE&gt;]</code></li>\n<li>Crie um job a partir de um Cronjob: <code class=\"language-text\">kubectl create job --from=cronjob/&lt;YOUR-CRONJOB-NAME&gt; &lt;GIVE-A-NAME&gt;</code></li>\n</ul>\n<p><em>Dica:</em> prefixes seus comandos com <code class=\"language-text\">watch</code> para ficar de olho no output. Por exemplo, se você fez deploy de uma nova imagem, verifique o progresso com o comando <code class=\"language-text\">watch kubectl get pods [-n namespace]</code>.</p>\n<h2>Deploy</h2>\n<ul>\n<li>Liste todos os deployments: <code class=\"language-text\">kubectl get deployments --all-namespaces</code></li>\n<li>Criar ou deletar um deploy é fácil: <code class=\"language-text\">kubectl [apply|delete] -f &lt;FOLDER-OR-FILE&gt;</code></li>\n<li>Escale: <code class=\"language-text\">kubectl scale deploy &lt;DEPLOY-NAME&gt; [-n &lt;NAMESPACE&gt;] --replicas=&lt;N&gt;</code></li>\n<li>Faça rollback de um deploy: <code class=\"language-text\">kubectl rollout undo deployment/&lt;DEPLOY-NAME&gt; [-n &lt;NAMESPACE&gt;]</code></li>\n<li>Delete evicted pods: <code class=\"language-text\">kubectl [-n &lt;NAMESPACE&gt;] delete pods --field-selector=status.phase=Failed</code></li>\n<li>Delete todos os pods: <code class=\"language-text\">kubectl delete --all pods [-n &lt;NAMESPACE&gt;]</code></li>\n<li>Restart nos pods: <code class=\"language-text\">kubectl rollout restart deployment &lt;DEPLOY-NAME&gt; [-n &lt;NAMESPACE&gt;]</code></li>\n</ul>\n<p>Dicas:_</p>\n<ol>\n<li><del>Nunca use</del> Evite usar o comando <code class=\"language-text\">scale deploy</code> pois você vai acabar criando uma diferença entre os arquivos yaml files e o que está aplicado no cluster, tornando uma bagunça descobrir o que está correto. Tudo bem usar em um cenário de emergência mas lembre-se de sempre atualizar o arquivo yaml ou os arquivos de HPA. No cenário normal, mantenha seus arquivos yaml atualizados e aplique-os para mudar o estado do cluster.</li>\n<li>Configurando <code class=\"language-text\">--replicas=0</code> é uma boa forma de parar o serviço por um período de tempo uma vez que você não deleta o deployment (mas releia a dica anterior).</li>\n</ol>\n<h2>Solução de problemas</h2>\n<ul>\n<li>Tenha uma visão geral dos deployments: <code class=\"language-text\">kubectl describe deploy &lt;DEPLOY-NAME&gt; [-n &lt;NAMESPACE&gt;]</code></li>\n<li>Tenha uma visão geral do pod: <code class=\"language-text\">kubectl describe pod &lt;POD-NAME&gt; [-n &lt;NAMESPACE&gt;]</code></li>\n<li>Verifique os logs: <code class=\"language-text\">kubectl logs -f &lt;POD-NAME&gt; [-n &lt;NAMESPACE&gt;] [--tail=&lt;N&gt;]</code></li>\n<li>Verifique os logs de um container anterior: <code class=\"language-text\">kubectl logs &lt;POD-NAME&gt; -c &lt;CONTAINER-NAME&gt; --previous</code></li>\n<li>Verifique os logs de todos os containers que possuem uma label: <code class=\"language-text\">kubectl logs -f -l &lt;KEY&gt;=&lt;VALUE&gt; --all-containers</code></li>\n<li>Obtenha uma shell interativo: <code class=\"language-text\">kubectl exec -it &lt;POD-NAME&gt; [-n &lt;NAMESPACE&gt;] -- /bin/bash</code></li>\n<li>Faça o dump de um recurso para um arquivo yaml: `kubectl get <OBJECT> <OBJECT-NAME> -o yaml > <filename>.yaml</li>\n<li>Obtenha as métricas de memória e cpu memory:\n** Todos os nós: <code class=\"language-text\">kubectl top nodes</code>\n** Um nó: <code class=\"language-text\">kubectl top node &lt;NODE-NAME&gt;</code>\n** Pod: <code class=\"language-text\">kubectl top pod &lt;POD-NAME&gt; [-n &lt;NAMESPACE&gt;]</code></li>\n</ul>\n<h2>Escalonamento / Migração</h2>\n<ul>\n<li>Marque um nó não-escalável: <code class=\"language-text\">kubectl cordon &lt;NODE-NAME&gt;</code></li>\n<li>Marque um nó escalável: <code class=\"language-text\">kubectl uncordon &lt;NODE-NAME&gt;</code></li>\n</ul>\n<h2>Helm</h2>\n<ul>\n<li>Solucione o erro devido a versões incompatíveis de client: <code class=\"language-text\">helm init --upgrade</code></li>\n<li>Liste os deployments do Helm: <code class=\"language-text\">helm ls</code></li>\n<li>Delete um deploy do helm: <code class=\"language-text\">helm delete &lt;NAME&gt; --purge</code></li>\n<li>Instale um chart: <code class=\"language-text\">helm install &lt;CHART-NAME&gt; --name &lt;YOUR-DEPLOY-NAME&gt; -f &lt;YAML-FILE&gt; [--namespace &lt;NAMESPACE&gt;]</code></li>\n<li>Atualize um chart: <code class=\"language-text\">helm upgrade &lt;NAME&gt; &lt;CHART&gt; -f &lt;YAML-FILE&gt;</code></li>\n</ul>\n<p>Isso é tudo, pessoal! À medida que eu utilizar mais comandos eu atualizo este post.</p>","frontmatter":{"title":"Kubernetes: meu cheat sheet pessoal","date":"2020-01-16T00:00:00.000Z","description":null,"tags":["kubernetes","devops","cheat","sheet","commands","k8s"],"image_url":null,"image_author":null,"image":{"publicURL":"/static/3e9278fbf345d1c50bb5a0aff63f85bc/featured.png"}},"fields":{"slug":"/2020/2020-01-16-Kubernetes_meu_cheat_sheet_pessoal/"},"timeToRead":4}},"pageContext":{"id":"78d12748-899b-5ed5-8e70-b502f28f8b27","language":"pt","intl":{"language":"pt","languages":["pt"],"messages":{"of":"de","or":"ou","Next":"Próximo","Previous":"Anterior","reading":"leitura","Comments":"Comentários","Featured_image_credits":"Créditos da imagem de destaque","Not_Found":"Não Encontrado","Not_Found_Text":"A página que você está procurando pode ter sido removida, ter seu nome alterado ou estar temporariamente indisponível.","Not_Found_Nav":"Você pode ir para","Warning_deprecated":"Atenção: esse post foi escrito há algum tempo e pode necessitar atualizações, ok?"},"routed":true,"originalPath":"/blog/2020/2020-01-16-Kubernetes_meu_cheat_sheet_pessoal/","redirect":true,"defaultLanguage":"pt"}}},"staticQueryHashes":["4061151221"]}