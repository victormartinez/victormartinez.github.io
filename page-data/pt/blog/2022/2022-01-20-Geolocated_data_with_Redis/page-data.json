{"componentChunkName":"component---src-templates-blog-post-js","path":"/pt/blog/2022/2022-01-20-Geolocated_data_with_Redis/","result":{"data":{"site":{"siteMetadata":{"title":null,"siteUrl":"https://vcrmartinez.com","social":{"twitter":"vcrmartinez","github":"victormartinez","linkedin":"vcrmartinez","speakerdeck":"victormartinez"}}},"markdownRemark":{"id":"66d0f86c-ad04-564e-a1cb-19d7bf5eab5e","excerpt":"TL;DR; We are going to use Redis to store geolocated data. Talking about Redis invariably makes us think about cache. However, it evolved and today it is…","html":"<p><em>TL;DR;</em> We are going to use Redis to store geolocated data.</p>\n<p>Talking about Redis invariably makes us think about cache. However, it evolved and today it is considered a server that stores different data structures (hashes, sets, lists, etc).</p>\n<p>In today’s post we are going to stay out of common usage and understand how Redis helps us to work with geolocated data (for more information, check the <a href=\"https://redis.io/commands#geo\">docs</a>).</p>\n<h2>Setting up environment</h2>\n<p>You need to set up an environment if you want to execute the commands. I’m using <a href=\"https://www.docker.com/\">docker</a> and <a href=\"https://redis.io/topics/rediscli\">redis-cli</a>. The latter comes after installing Redis but I like to have it apart (check this <a href=\"https://codewithhugo.com/install-just-redis-cli-on-ubuntu-debian-jessie/\">tutorial</a>). Then, just execute the commands below:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker run --name<span class=\"token operator\">=</span>my-redis --rm -p <span class=\"token string\">\"6379:6379\"</span> redis:6 redis-server\n$ redis-cli\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> </code></pre></div>\n<h2>Data structure</h2>\n<p>Storing anything in Redis requires usage of index. In a simple manner, it is a <em>string</em> that points to a data structure. To handle geolocated data Redis uses the structure <em>sorted set</em> in such way that each point (lat/long) is labeled by a <strong>string</strong>. The simplified image below illustrates the architecture:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 497px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAB70lEQVQoz42TTU9TQRSG+w/cGhM3JibuWPpvgKSCgQU2bmzA+B/cQP1gQSQY1GBitLoxSixIrU0wUQkItKKUaL8ohd47d+bexzO3vaUmRDzJuedjZt77znsysfxInNcXzpG53Mfzs2eob6xjAOW6KKXwPK8bo9zXNlf83j9CS89o2/dotVrEivNzvOq7RPriefKJUXTzgNB8H4Lg2MXaX2iqgMm3P0nMb3A/U8LV7RVHSMTkGDtfPrP5bpFK4wAdRMf+tkD6vt9em10sMHhvlcTcVwYkPs7thf2W4wigMThCW9s/CGVfa3S5jCqVuq6r1S7wkfKZeJBnKLXM6HSOuMSJJ2toYaaUMLSbrA6BMe2bCmhx7BrbV4bYHb/Jdv8AhRtJqgK6X6uw8ukbyZk8w3eWGZn+QHwyw/XZVSqHGiO6hoBWbN9qZgElb2YyVNNpvi8sUEu/pLmSxRg/VLHccBif+chwaomrd98Tn1oi+WiNQ2HuRQx7ASMFbdUQTaI66Fm7/WKdwVSWMWHaP5Ul9WanPRTnJEARP7B5VEsM3Q6lM7CtikPyaYHRh5vcelZkt+4eDyUCDE6Y7r96xb0a6dwWP37Vuzdw3R6GRoZiWf6ve66DajXlATiYzg2ciKEFczsvw/ppeRjDl6PD2Nv/A5eAKmFqZMPsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"Simplified architecture of geoloc data structure.\"\n        title=\"Simplified architecture of geoloc data structure.\"\n        data-src=\"/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/15d25/redis-geoloc-architecture.png\"\n        data-srcset=\"/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/8ff5a/redis-geoloc-architecture.png 240w,\n/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/e85cb/redis-geoloc-architecture.png 480w,\n/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/15d25/redis-geoloc-architecture.png 497w\"\n        sizes=\"(max-width: 497px) 100vw, 497px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>In the example we have an index named <em>Salvador</em> (city I’m born and bred =)) that points to a set of points.</p>\n<p><strong>Attention:</strong> as redis uses sorted set it is not possible to store two points with the same label. The insertion of a point correspond to an update of coordinates (<strong>upsert</strong>).</p>\n<h2>Getting the hands dirty</h2>\n<p>Redis gives us an API with the following commands: <code class=\"language-text\">GEOADD</code>,<code class=\"language-text\">GEODIST</code>, <code class=\"language-text\">GEOHASH</code>, <code class=\"language-text\">GEOPOS</code>, <code class=\"language-text\">GEOSEARCH</code>. Let’s start by adding some points to the index <code class=\"language-text\">location:salvador</code>:</p>\n<p><strong>Attention:</strong> The commands will soon be deprecated: <code class=\"language-text\">GEOMEMBER</code>, <code class=\"language-text\">GEORADIUS</code>, <code class=\"language-text\">GEORADIUS_RO</code>, <code class=\"language-text\">GEORADIUSBYMEMBER</code>, <code class=\"language-text\">GEORADIUSBYMEMBER_RO</code>. Due to that we won’t use them in this post.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOADD location:salvador -38.5139209 -12.9730385 mercadomodelo -38.5329599 -13.0101531 faroldabarra -38.5260635 -13.0107505 morrodocristo</code></pre></div>\n<p>Two <strong>important</strong> observations:</p>\n<ol>\n<li>\n<p>Redis takes <strong>first</strong> the longitude.</p>\n<ol>\n<li><code class=\"language-text\">CMD &lt;set-name&gt; &lt;long&gt; &lt;lat&gt; &lt;member-name&gt;</code></li>\n</ol>\n</li>\n<li>We are going to handle points inside an index and, thus, I used the <em>lowercase</em> pattern for labels and index. That avoids some typos during the search and makes it legible enough (see <em>Redis keys</em> section in <a href=\"https://redis.io/topics/data-types-intro\">docs</a>).</li>\n</ol>\n<p>Once we have the points inserted, we can play with the API. Let’s dive into some use cases.</p>\n<h3>Get longitude and latitude</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOPOS location:salvador faroldabarra\n\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.53296071290969849\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.01015213126540715\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.52607816457748413\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.0107807421129209\"</span></code></pre></div>\n<h3>Calc distance (in meters) between two points</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEODIST location:salvador faroldabarra morrodocristo\n\n<span class=\"token string\">\"749.1386\"</span></code></pre></div>\n<p><em>OBS</em>: You can provide, at the end, the distance metric you want to use (m, km, ft, mi).</p>\n<h3>Update a point</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOADD location:salvador -38 -12 elevadorlacerda\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOADD location:salvador -38.5159605 -12.9740495 elevadorlacerda\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOPOS location:salvador elevadorlacerda</code></pre></div>\n<p><em>OBS:</em> Since we are working with a set, updating a point occurs by adding a new point with the same label.</p>\n<h3>Search</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Points in a radius of 1600 meters from a specific coordinate</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCH location:salvador FROMLONLAT -38.5175291 -13.0060716 BYRADIUS <span class=\"token number\">1600</span> m\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n\n<span class=\"token comment\"># Points in a radius of 200 km from an existing point</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCH location:salvador FROMMEMBER faroldabarra BYRADIUS <span class=\"token number\">200</span> km\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"elevadorlacerda\"</span>\n<span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span>\n\n<span class=\"token comment\"># Same query above but retrieving coords and distance</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCH location:salvador FROMMEMBER faroldabarra BYRADIUS <span class=\"token number\">200</span> km WITHCOORD WITHDIST\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"0.0000\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.53296071290969849\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.01015213126540715\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"0.7491\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.52607816457748413\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.0107807421129209\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"elevadorlacerda\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"4.4180\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.51596087217330933\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-12.97405009779294005\"</span>\n<span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"4.6149\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.51392239332199097\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-12.97303874405036339\"</span></code></pre></div>\n<p><strong>Obs:</strong></p>\n<ul>\n<li><code class=\"language-text\">GEOSEARCH</code> allows to constraint the quantity of results by receiving the <code class=\"language-text\">COUNT</code> parameter.</li>\n<li>Replace <code class=\"language-text\">BYRADIUS 200 km</code> by <code class=\"language-text\">BYBOX 200 200 km</code> and Redis will consider a rectangle rather than a circular area.</li>\n<li>It’s possible to retrieve values sorted by distance: add <code class=\"language-text\">ASC</code> or <code class=\"language-text\">DESC</code> to the end of the query.</li>\n</ul>\n<h3>Store the search results</h3>\n<p>Redis allows you to search and store the result in a specific index of your choice. In the example belo we search in <code class=\"language-text\">location:salvador</code> and store the results into <code class=\"language-text\">location:results:salvador</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCHSTORE location:results:salvador location:salvador FROMMEMBER faroldabarra BYRADIUS <span class=\"token number\">200</span> km\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> KEYS *\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"location:salvador\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"location:results:salvador\"</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZRANGE location:results:salvador <span class=\"token number\">0</span> -1\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span></code></pre></div>\n<h3>Geohash</h3>\n<p>Redis uses a Geohash (string comprised of 11 chars) to represent points in such way that it can be translated to a coord (lat / long).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOHASH location:salvador morrodocristo faroldabarra\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"7jstgr6nvs0\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"7jstgpt4kg0\"</span></code></pre></div>\n<p>You can verify the transation geohash ↔ lat/long by the website <em><a href=\"https://geohash.org/\">https://geohash.org/</a><coloque-aqui-o-geohash></em>.</p>\n<h3><em>Sorted Set</em> operations</h3>\n<p>Since Redis stores the geoloc in the form of a sorted set, it it is possible to access the data using the API provided to handle sorted sets. Let’s see some examples (all commands are available in the <a href=\"https://redis.io/commands#sorted-set\">docs</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZRANGE location:salvador <span class=\"token number\">0</span> -1\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"elevadorlacerda\"</span>\n<span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZREM location:salvador elevadorlacerda\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZCARD location:salvador\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">3</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZCOUNT location:salvador -inf +inf\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">3</span></code></pre></div>\n<h2>Final thoughts</h2>\n<ul>\n<li>Think about Redis beyond the key-value store. There are other data structures for you to play with.</li>\n<li>Be careful naming index and the points. You will need to retrieve them in a intelligent way that avoids typos.</li>\n<li>Before inserting all the points take a time to consider how you will search the data. Does it make sense to store all points in a single index? What if you need to do <em>sharding</em>?</li>\n</ul>\n<p>That’s it. Did you like the post?</p>","frontmatter":{"title":"Geolocated data with Redis","date":"2022-01-20T00:00:00.000Z","description":null,"tags":["redis","geolocation","lat","long","nosql"],"rating":null,"image_url":"https://unsplash.com/photos/TrhLCn1abMU","image_author":"Z","image":{"publicURL":"/static/ed3b0fc3140da9102fd76e21987a3a7b/featured.jpg"}},"fields":{"slug":"/2022/2022-01-20-Geolocated_data_with_Redis/"},"timeToRead":5}},"pageContext":{"id":"66d0f86c-ad04-564e-a1cb-19d7bf5eab5e","language":"pt","intl":{"language":"pt","languages":["en","pt"],"messages":{"of":"de","or":"ou","Next":"Próximo","Previous":"Anterior","reading":"leitura","Comments":"Comentários","Featured_image_credits":"Créditos da imagem de destaque","Not_Found":"Não Encontrado","Not_Found_Text":"A página que você está procurando pode ter sido removida, ter seu nome alterado ou estar temporariamente indisponível.","Not_Found_Nav":"Você pode ir para","Warning_deprecated":"Atenção: esse post foi escrito a algum tempo e pode não ser mais válido, ok?"},"routed":true,"originalPath":"/blog/2022/2022-01-20-Geolocated_data_with_Redis/","redirect":true,"defaultLanguage":"en"}}},"staticQueryHashes":["4061151221"]}