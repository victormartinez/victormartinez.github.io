{"componentChunkName":"component---src-templates-blog-post-js","path":"/pt/blog/2022/2022-01-20-Dados_geolocalizados_com_Redis/","result":{"data":{"site":{"siteMetadata":{"title":null,"siteUrl":"https://vcrmartinez.com","social":{"twitter":"vcrmartinez","github":"victormartinez","linkedin":"vcrmartinez","speakerdeck":"victormartinez"}}},"markdownRemark":{"id":"80df4b9d-7ca5-5eab-a3d5-7f5777777bcc","excerpt":"TL;DR; Vamos usar o Redis para armazenar dados geolocalizados. Quando falamos em Redis invariavelmente pensamos em cache. Por√©m ele evoluiu e hoje √© considerado‚Ä¶","html":"<p><em>TL;DR;</em> Vamos usar o Redis para armazenar dados geolocalizados.</p>\n<p>Quando falamos em Redis invariavelmente pensamos em cache. Por√©m ele evoluiu e hoje √© considerado um servidor que armazena diferentes estruturas de dados (hashes, sets, lists, etc).</p>\n<p>No post de hoje vamos sair do uso comum e entender de que forma o Redis nos ajuda com quando precisamos trabalhar dados geolocalizados (para mais info, vide <a href=\"https://redis.io/commands#geo\">documenta√ß√£o</a>).</p>\n<h2>Configura√ß√£o do ambiente</h2>\n<p>Para replicar os comandos voc√™ vai precisar configurar um ambiente local. Estou usando o <a href=\"https://www.docker.com/\">docker</a> e o <a href=\"https://redis.io/topics/rediscli\">redis-cli</a>. O CLI vem com a instala√ß√£o do Redis mas eu gosto de t√™-lo separado (veja este <a href=\"https://codewithhugo.com/install-just-redis-cli-on-ubuntu-debian-jessie/\">tutorial</a>). Ent√£o, basta executar os comandos abaixo:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ docker run --name<span class=\"token operator\">=</span>my-redis --rm -p <span class=\"token string\">\"6379:6379\"</span> redis:6 redis-server\n$ redis-cli\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> </code></pre></div>\n<h2>Estrutura de Dados</h2>\n<p>Armazenar qualquer coisa no Redis requer a utiliza√ß√£o de √≠ndices. De forma simples, √© uma chave <em>string</em> que aponta para alguma estrutura de dados. Para lidar com dados geolocalizados o Redis utiliza a estrutura de <em>sorted set</em> (conjunto ordenado) de forma que cada ponto (lat/long) √© rotulado com uma <strong>string</strong>. A imagem abaixo ilustra de forma simplificada essa arquitetura:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 497px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.08333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAAB70lEQVQoz42TTU9TQRSG+w/cGhM3JibuWPpvgKSCgQU2bmzA+B/cQP1gQSQY1GBitLoxSixIrU0wUQkItKKUaL8ohd47d+bexzO3vaUmRDzJuedjZt77znsysfxInNcXzpG53Mfzs2eob6xjAOW6KKXwPK8bo9zXNlf83j9CS89o2/dotVrEivNzvOq7RPriefKJUXTzgNB8H4Lg2MXaX2iqgMm3P0nMb3A/U8LV7RVHSMTkGDtfPrP5bpFK4wAdRMf+tkD6vt9em10sMHhvlcTcVwYkPs7thf2W4wigMThCW9s/CGVfa3S5jCqVuq6r1S7wkfKZeJBnKLXM6HSOuMSJJ2toYaaUMLSbrA6BMe2bCmhx7BrbV4bYHb/Jdv8AhRtJqgK6X6uw8ukbyZk8w3eWGZn+QHwyw/XZVSqHGiO6hoBWbN9qZgElb2YyVNNpvi8sUEu/pLmSxRg/VLHccBif+chwaomrd98Tn1oi+WiNQ2HuRQx7ASMFbdUQTaI66Fm7/WKdwVSWMWHaP5Ul9WanPRTnJEARP7B5VEsM3Q6lM7CtikPyaYHRh5vcelZkt+4eDyUCDE6Y7r96xb0a6dwWP37Vuzdw3R6GRoZiWf6ve66DajXlATiYzg2ciKEFczsvw/ppeRjDl6PD2Nv/A5eAKmFqZMPsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image lazyload\"\n        alt=\"Ilustra√ß√£o simplificada da estrutura de dados.\"\n        title=\"Ilustra√ß√£o simplificada da estrutura de dados.\"\n        data-src=\"/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/15d25/redis-geoloc-architecture.png\"\n        data-srcset=\"/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/8ff5a/redis-geoloc-architecture.png 240w,\n/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/e85cb/redis-geoloc-architecture.png 480w,\n/static/411523fdcb3ebd9c49ad3bc74f2cf8d9/15d25/redis-geoloc-architecture.png 497w\"\n        sizes=\"(max-width: 497px) 100vw, 497px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>No exemplo, criamos um √≠ndice chamado <em>Salvador</em> (cidade em que sou nascido e criado üòä) que aponta para um conjunto de pontos.</p>\n<p><strong>Aten√ß√£o:</strong> como o Redis utiliza a estrutura de conjuntos n√£o √© poss√≠vel existir no mesmo √≠ndice dois pontos com o mesmo nome. A inser√ß√£o de um ponto com o mesmo nome corresponde a uma atualiza√ß√£o das coordenadas (opera√ß√£o de <em>upsert</em>).</p>\n<h2>M√£os √† obra</h2>\n<p>O Redis nos fornece uma API com os seguintes comandos: <code class=\"language-text\">GEOADD</code>,<code class=\"language-text\">GEODIST</code>, <code class=\"language-text\">GEOHASH</code>, <code class=\"language-text\">GEOPOS</code>, <code class=\"language-text\">GEOSEARCH</code>. Vamos iniciar adicionando alguns pontos ao √≠ndice <code class=\"language-text\">location:salvador</code>:</p>\n<p><strong>Aten√ß√£o:</strong> Os comandos logo ser√£o depreciados: <code class=\"language-text\">GEOMEMBER</code>, <code class=\"language-text\">GEORADIUS</code>, <code class=\"language-text\">GEORADIUS_RO</code>, <code class=\"language-text\">GEORADIUSBYMEMBER</code>, <code class=\"language-text\">GEORADIUSBYMEMBER_RO</code>. Por isso, n√£o vamos explor√°-los neste post.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOADD location:salvador -38.5139209 -12.9730385 mercadomodelo -38.5329599 -13.0101531 faroldabarra -38.5260635 -13.0107505 morrodocristo</code></pre></div>\n<p>Aqui, duas observa√ß√µes <strong>importantes</strong>:</p>\n<ol>\n<li>\n<p>O redis recebe <strong>primeiro</strong> a longitude e depois a latitude.</p>\n<ol>\n<li><code class=\"language-text\">CMD &lt;set-name&gt; &lt;long&gt; &lt;lat&gt; &lt;member-name&gt;</code></li>\n</ol>\n</li>\n<li>Como vamos manipular os pontos dentro do √≠ndice eu optei por adotar um padr√£o <em>lowercase</em> nas strings e no √≠ndice. Isso evita erros na busca e tamb√©m torna suficientemente leg√≠vel os dados armazenados (veja a se√ß√£o <em>Redis keys</em> da <a href=\"https://redis.io/topics/data-types-intro\">documenta√ß√£o</a>).</li>\n</ol>\n<p>Uma vez inseridos os pontos, podemos brincar com a API. Vamos a alguns casos de uso.</p>\n<h3>Obter longitude e latitude de um ou mais pontos</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOPOS location:salvador faroldabarra\n\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.53296071290969849\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.01015213126540715\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.52607816457748413\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.0107807421129209\"</span></code></pre></div>\n<h3>Calcular a dist√¢ncia, em metros, entre dois pontos</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEODIST location:salvador faroldabarra morrodocristo\n\n<span class=\"token string\">\"749.1386\"</span></code></pre></div>\n<p><em>OBS:</em> Voc√™ pode passar, no final, a m√©trica de dist√¢ncia que voc√™ quer (m, km, ft, mi).</p>\n<h3>Atualizar um ponto</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOADD location:salvador -38 -12 elevadorlacerda\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOADD location:salvador -38.5159605 -12.9740495 elevadorlacerda\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOPOS location:salvador elevadorlacerda</code></pre></div>\n<p><em>OBS:</em> Como estamos trabalhando com conjuntos a atualiza√ß√£o de um ponto se d√° por inserir um ponto com a mesma string (itens repetidos n√£o s√£o permitidos).</p>\n<h3>Buscar</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Pontos em um raio de 1600 metros a uma determinada longitude/latitude</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCH location:salvador FROMLONLAT -38.5175291 -13.0060716 BYRADIUS <span class=\"token number\">1600</span> m\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n\n<span class=\"token comment\"># Pontos em um raio de 200 km de um ponto existente</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCH location:salvador FROMMEMBER faroldabarra BYRADIUS <span class=\"token number\">200</span> km\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"elevadorlacerda\"</span>\n<span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span>\n\n<span class=\"token comment\"># A mesma query acima por√©m com as coordenadas e a dist√¢ncia</span>\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCH location:salvador FROMMEMBER faroldabarra BYRADIUS <span class=\"token number\">200</span> km WITHCOORD WITHDIST\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"0.0000\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.53296071290969849\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.01015213126540715\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"0.7491\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.52607816457748413\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-13.0107807421129209\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"elevadorlacerda\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"4.4180\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.51596087217330933\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-12.97405009779294005\"</span>\n<span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span>\n   <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"4.6149\"</span>\n   <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-38.51392239332199097\"</span>\n      <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"-12.97303874405036339\"</span></code></pre></div>\n<p><strong>Observa√ß√µes:</strong></p>\n<ul>\n<li><code class=\"language-text\">GEOSEARCH</code> tamb√©m permite restringir a quantidade de resultados por meio do par√¢metro <code class=\"language-text\">COUNT</code>.</li>\n<li>Substitua o <code class=\"language-text\">BYRADIUS 200 km</code> por <code class=\"language-text\">BYBOX 200 200 km</code> e o Redis ir√° considerar um ret√¢ngulo ao inv√©s de uma √°rea circular.</li>\n<li>√â poss√≠vel retornar os valores ordenados pela dist√¢ncia. Basta adicionar <code class=\"language-text\">ASC</code> ou <code class=\"language-text\">DESC</code> ao final da busca.</li>\n</ul>\n<h3>Armazenar os resultados da busca</h3>\n<p>O redis permite que voc√™ fa√ßa uma busca e armazene em um √≠ndice espec√≠fico. No exemplo abaixo buscamos em <code class=\"language-text\">location:salvador</code> e armazenamos em <code class=\"language-text\">location:results:salvador</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOSEARCHSTORE location:results:salvador location:salvador FROMMEMBER faroldabarra BYRADIUS <span class=\"token number\">200</span> km\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> KEYS *\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"location:salvador\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"location:results:salvador\"</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZRANGE location:results:salvador <span class=\"token number\">0</span> -1\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span></code></pre></div>\n<h3>Geohash</h3>\n<p>Redis usa a representa√ß√£o em Geohash, string de 11 caracteres, para representar os pontos no conjunto de forma que ela pode ser traduzida em uma coordenada (lat / long). </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> GEOHASH location:salvador morrodocristo faroldabarra\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"7jstgr6nvs0\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"7jstgpt4kg0\"</span></code></pre></div>\n<p>Voc√™ pode verificar esse mapeamento geohash ‚Üî lat/long por meio do site <em><a href=\"https://geohash.org/\">https://geohash.org/</a><coloque-aqui-o-geohash></em>.</p>\n<h3>Opera√ß√µes com <em>Sorted Set</em></h3>\n<p>Como o Redis armazena essa estrutura na forma de <em>sorted sets</em> ent√£o √© poss√≠vel acessar esses dados usando APIs dessa estrutura de dados. Vejamos alguns exemplos (todos os comandos est√£o na <a href=\"https://redis.io/commands#sorted-set\">documenta√ß√£o</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZRANGE location:salvador <span class=\"token number\">0</span> -1\n<span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"faroldabarra\"</span>\n<span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"morrodocristo\"</span>\n<span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"elevadorlacerda\"</span>\n<span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"mercadomodelo\"</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZREM location:salvador elevadorlacerda\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZCARD location:salvador\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">3</span>\n\n<span class=\"token number\">127.0</span>.0.1:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> ZCOUNT location:salvador -inf +inf\n<span class=\"token punctuation\">(</span>integer<span class=\"token punctuation\">)</span> <span class=\"token number\">3</span></code></pre></div>\n<h2>Considera√ß√µes Finais</h2>\n<ul>\n<li>Pense no Redis al√©m da chave-valor. Existem outras estruturas de dados para voc√™ brincar.</li>\n<li>Cuidado com o nome do √≠ndice e dos pontos. Voc√™ vai precisar busc√°-los de uma forma inteligente e que evite erros de digita√ß√£o.</li>\n<li>Antes de inserir todos os pontos pense em como voc√™ vai buscar os dados. Ser√° que faz sentido todos os pontos estarem no mesmo √≠ndice? E se voc√™ precisar fazer <em>sharding</em>?</li>\n</ul>\n<p>E ai, curtiu o post?</p>","frontmatter":{"title":"Dados geolocalizados com Redis","date":"2022-01-20T00:00:00.000Z","description":null,"tags":["redis","geolocation","lat","long","nosql"],"image_url":"https://unsplash.com/photos/TrhLCn1abMU","image_author":"Z","image":{"publicURL":"/static/ed3b0fc3140da9102fd76e21987a3a7b/featured.jpg"}},"fields":{"slug":"/2022/2022-01-20-Dados_geolocalizados_com_Redis/"},"timeToRead":5}},"pageContext":{"id":"80df4b9d-7ca5-5eab-a3d5-7f5777777bcc","language":"pt","intl":{"language":"pt","languages":["pt"],"messages":{"of":"de","or":"ou","Next":"Pr√≥ximo","Previous":"Anterior","reading":"leitura","Featured_image_credits":"Imagem de destaque","Not_Found":"N√£o Encontrado","Not_Found_Text":"A p√°gina que voc√™ est√° procurando pode ter sido removida, ter seu nome alterado ou estar temporariamente indispon√≠vel.","Not_Found_Nav":"Voc√™ pode ir para","Warning_deprecated":"Aten√ß√£o: esse post foi escrito h√° algum tempo e pode necessitar atualiza√ß√µes, ok?"},"routed":true,"originalPath":"/blog/2022/2022-01-20-Dados_geolocalizados_com_Redis/","redirect":true,"defaultLanguage":"pt"}}},"staticQueryHashes":["4061151221"]}