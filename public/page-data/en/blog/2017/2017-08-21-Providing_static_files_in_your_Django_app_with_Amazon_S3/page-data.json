{"componentChunkName":"component---src-templates-blog-post-js","path":"/en/blog/2017/2017-08-21-Providing_static_files_in_your_Django_app_with_Amazon_S3/","result":{"data":{"site":{"siteMetadata":{"title":null,"siteUrl":"https://vcrmartinez.com","social":{"twitter":"vcrmartinez","github":"victormartinez","linkedin":"vcrmartinez","speakerdeck":"victormartinez"}}},"markdownRemark":{"id":"ef7a27dd-994f-5a60-97c8-d32fe794b32d","excerpt":"It is well-known that Django does not provide static files. Using a WSGI Middleware to address the issue is not the right way to provide static files and, thus…","html":"<p>It is well-known that Django does not provide static files. Using a WSGI Middleware to address the issue is not the right way to provide static files and, thus, this post show how you can do it using Amazon S3.</p>\n<h3>Django backend storages</h3>\n<p>Django uses an architecture of backend storages to store data (e.g. the <a href=\"https://docs.djangoproject.com/en/1.11/ref/files/storage/\">FileSystemStorage</a> is responsible for saving files in the current file system). However, you might want to adopt a different approach and, thus, by following the <a href=\"https://docs.djangoproject.com/en/1.11/howto/custom-file-storage/\">Storage Interface</a> it is possible to implement your own way to handle storage. A project called <a href=\"https://github.com/jschneier/django-storages\">django-storages</a> has already thought about common problems and implemented for us a storage that send files to Amazon S3 with almost no effort required. Let’s use it!</p>\n<h3>Creating an Amazon S3 bucket</h3>\n<p>Go to Amazon S3, create a bucket with two folders inside: <em>static</em> and <em>media</em>. In this example it is assumed there is a public access for listing your S3 objects.</p>\n<p><strong>Note:</strong> In this post we talk about folders but it is just an abstraction. The <a href=\"http://docs.aws.amazon.com/AmazonS3/latest/UG/FolderOperations.html\">S3 documentation</a> explains that buckets and objects are the primary resources and there is no such hierarchy like a typical file system.</p>\n<h3>Install the requirements</h3>\n<p>You will need to install the <a href=\"https://github.com/boto/boto3\">boto</a> and <a href=\"https://github.com/jschneier/django-storages\">django-storages</a> packages.</p>\n<p>As explained before django-storages will help us to send files to Amazon S3. However, we need to install boto because it will provide the connection to amazon services.</p>\n<p><strong>Note:</strong> This post uses <a href=\"https://github.com/henriquebastos/python-decouple\">python-decouple</a> to manage local environments. If you do not know how to use it check this <a href=\"/en/blog/2017/2017-08-15-Prepare_your_Django_app_to_be_deployed_at_Heroku/\">post</a>.</p>\n<h3>Creating our custom backends</h3>\n<p>In our configuration directory we will create the backends responsible to dealing with Amazon S3. Create a file called <em>s3util.py</em> and add the content below:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>conf <span class=\"token keyword\">import</span> settings\n<span class=\"token keyword\">from</span> storages<span class=\"token punctuation\">.</span>backends<span class=\"token punctuation\">.</span>s3boto <span class=\"token keyword\">import</span> S3BotoStorage\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">StaticStorage</span><span class=\"token punctuation\">(</span>S3BotoStorage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    location <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>STATICFILES_LOCATION\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MediaStorage</span><span class=\"token punctuation\">(</span>S3BotoStorage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    location <span class=\"token operator\">=</span> settings<span class=\"token punctuation\">.</span>MEDIAFILES_LOCATION</code></pre></div>\n<ul>\n<li>Lines 1-2: Import the modules.</li>\n<li>Lines 5-10: Represent our storages. The location attribute is set with the location of static and media files defined in the <em>settings.py</em> file.</li>\n</ul>\n<h3>Configuring Amazon S3 variables</h3>\n<p>Assuming you already have an Amazon S3 bucket available, lets add some variables to <em>settings.py</em> file.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> decouple <span class=\"token keyword\">import</span> config\n\n<span class=\"token comment\"># AWS</span>\nAWS_S3_SECURE_URLS <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nAWS_QUERYSTRING_AUTH <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\nAWS_PRELOAD_METADATA <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\nAWS_STORAGE_BUCKET_NAME <span class=\"token operator\">=</span> <span class=\"token string\">'&lt;YOUR-BUCKET-NAME>'</span>\nAWS_ACCESS_KEY_ID <span class=\"token operator\">=</span> config<span class=\"token punctuation\">(</span><span class=\"token string\">'AWS_ACCESS_KEY_ID'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\nAWS_SECRET_ACCESS_KEY <span class=\"token operator\">=</span> config<span class=\"token punctuation\">(</span><span class=\"token string\">'AWS_SECRET_ACCESS_KEY'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n\nSTATICFILES_STORAGE <span class=\"token operator\">=</span> config<span class=\"token punctuation\">(</span><span class=\"token string\">'STATICFILES_STORAGE'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token string\">'django.contrib.staticfiles.storage.StaticFilesStorage'</span><span class=\"token punctuation\">)</span>\nDEFAULT_FILE_STORAGE <span class=\"token operator\">=</span> config<span class=\"token punctuation\">(</span><span class=\"token string\">'DEFAULT_FILE_STORAGE'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token string\">'django.core.files.storage.FileSystemStorage'</span><span class=\"token punctuation\">)</span>\n\nSTATIC_URL <span class=\"token operator\">=</span> config<span class=\"token punctuation\">(</span><span class=\"token string\">'STATIC_URL'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token string\">'/static/'</span><span class=\"token punctuation\">)</span>\nMEDIA_URL <span class=\"token operator\">=</span> config<span class=\"token punctuation\">(</span><span class=\"token string\">'MEDIA_URL'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span><span class=\"token string\">'/media/'</span><span class=\"token punctuation\">)</span>\n\nAWS_HEADERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'x-amz-acl'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'public-read'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'Cache-Control'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'public, max-age=31556926'</span>\n<span class=\"token punctuation\">}</span>\n\nSTATICFILES_LOCATION <span class=\"token operator\">=</span> <span class=\"token string\">'static'</span>\nMEDIAFILES_LOCATION <span class=\"token operator\">=</span> <span class=\"token string\">'media'</span></code></pre></div>\n<ul>\n<li>Line 1: Make sure you have imported the config module. It will look for the respective env variable and, in case of absence, it looks for an .env file (check this post).</li>\n<li>Line 4: Use secure SSL urls for serving objects from S3.</li>\n<li>Line 5: We don’t want to generate S3 auth querystring.</li>\n<li>Line 6: We want to preload the S3 metadata.</li>\n<li>Line 7: It is necessary to provide the bucket name you created at Amazon S3.</li>\n<li>Lines 8-9: Config will look for env vars or an .env file with those variables. In a local environment they will be blank because we will not send files to S3 in development mode. However, in production we will set those variables.</li>\n<li>Lines 11-12: Those variables will explicit define which storage our project will use to store the static files. In local environment the default value will be the ordinary backend (StaticFilesStorage and FileSystemStorage). However, in production, we will set the backends responsible for sending the file to S3.</li>\n<li>Lines 14-15: Point to the static and media urls. In production they store the amazon s3 url that correspond to each type (static or media).</li>\n<li>Lines 17-20: AWS Headers that explicit our cache policy.</li>\n<li>Lines 22-23: Those variables tell our backend where are our media and static files. They are used in our s3util.py file.</li>\n</ul>\n<h3>Local Variables</h3>\n<p>In a nutshell, our local variables will end up being:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">AWS_S3_SECURE_URLS <span class=\"token operator\">=</span> True\nAWS_QUERYSTRING_AUTH <span class=\"token operator\">=</span> False\nAWS_PRELOAD_METADATA <span class=\"token operator\">=</span> True\nAWS_STORAGE_BUCKET_NAME <span class=\"token operator\">=</span> <span class=\"token string\">'BUCKET-NAME'</span>\nAWS_ACCESS_KEY_ID <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\nAWS_SECRET_ACCESS_KEY <span class=\"token operator\">=</span> <span class=\"token string\">''</span>\n\nSTATICFILES_STORAGE <span class=\"token operator\">=</span> <span class=\"token string\">'django.contrib.staticfiles.storage.StaticFilesStorage'</span>\nDEFAULT_FILE_STORAGE <span class=\"token operator\">=</span> <span class=\"token string\">'django.core.files.storage.FileSystemStorage'</span>\n\nSTATIC_URL <span class=\"token operator\">=</span> <span class=\"token string\">'/static/'</span>\nMEDIA_URL <span class=\"token operator\">=</span> <span class=\"token string\">'/media/'</span>\n\nAWS_HEADERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'x-amz-acl'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'public-read'</span>,\n    <span class=\"token string\">'Cache-Control'</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'public, max-age=31556926'</span>\n<span class=\"token punctuation\">}</span>\n\nSTATICFILES_LOCATION <span class=\"token operator\">=</span> <span class=\"token string\">'static'</span>\nMEDIAFILES_LOCATION <span class=\"token operator\">=</span> <span class=\"token string\">'media'</span></code></pre></div>\n<h3>Production Variables</h3>\n<p>It is necessary to set the production variables.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">heroku config:set <span class=\"token assign-left variable\">AWS_ACCESS_KEY_ID</span><span class=\"token operator\">=</span><span class=\"token string\">'&lt;YOUR-ACCESS-KEY>'</span> -a <span class=\"token operator\">&lt;</span>YOUR_APP<span class=\"token operator\">></span>\nheroku config:set <span class=\"token assign-left variable\">AWS_SECRET_ACCESS_KEY</span><span class=\"token operator\">=</span><span class=\"token string\">'&lt;YOUR-SECRET-KEY>'</span> -a <span class=\"token operator\">&lt;</span>YOUR_APP<span class=\"token operator\">></span>\nheroku config:set <span class=\"token assign-left variable\">DEFAULT_FILE_STORAGE</span><span class=\"token operator\">=</span><span class=\"token string\">'config.s3util.MediaStorage'</span> -a <span class=\"token operator\">&lt;</span>YOUR_APP<span class=\"token operator\">></span>\nheroku config:set <span class=\"token assign-left variable\">STATICFILES_STORAGE</span><span class=\"token operator\">=</span><span class=\"token string\">'config.s3util.StaticStorage'</span> -a <span class=\"token operator\">&lt;</span>YOUR_APP<span class=\"token operator\">></span>\nheroku config:set <span class=\"token assign-left variable\">MEDIA_URL</span><span class=\"token operator\">=</span><span class=\"token string\">'https://s3.amazonaws.com/&lt;YOUR-BUCKET-NAME>/media/'</span> -a <span class=\"token operator\">&lt;</span>YOUR_APP<span class=\"token operator\">></span>\nheroku config:set <span class=\"token assign-left variable\">STATIC_URL</span><span class=\"token operator\">=</span><span class=\"token string\">'https://s3.amazonaws.com/&lt;YOUR-BUCKET-NAME>/static/'</span> -a <span class=\"token operator\">&lt;</span>YOUR_APP<span class=\"token operator\">></span></code></pre></div>\n<p><strong>Note:</strong> You can pass multiple variables in one declaration:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">heroku config:set <span class=\"token assign-left variable\">AWS_ACCESS_KEY_ID</span><span class=\"token operator\">=</span><span class=\"token string\">'&lt;YOUR-ACCESS-KEY>'</span> <span class=\"token assign-left variable\">AWS_SECRET_ACCESS_KEY</span><span class=\"token operator\">=</span><span class=\"token string\">'&lt;YOUR-SECRET-KEY>'</span> <span class=\"token punctuation\">..</span>. -a <span class=\"token operator\">&lt;</span>YOUR_APP<span class=\"token operator\">></span></code></pre></div>\n<h3>Sending files to S3</h3>\n<p>From now on every time you push your project to Heroku it will send the files to Amazon S3. That will happen because Heroku executes <code class=\"language-text\">$ python manage.py collectstatic</code> during the deploy pipeline and that command will collect the static files and save it. Once our production backend saves into S3 all files will be sent to the remote server.</p>\n<p>If you are not using Heroku make sure you run <code class=\"language-text\">python manage.py collectstatic</code> in production.</p>\n<p><strong>Note:</strong> A test can be done locally by setting the production variables in the local environment. That way, if you run the collectstatic command it will send the files to S3. Just make sure to unset them after that.</p>","frontmatter":{"title":"Providing static files in your Django app with Amazon S3","date":"2017-08-21T00:00:00.000Z","description":null,"tags":["aws","django","python","s3","storage"],"rating":null,"image_url":null,"image_author":null},"fields":{"slug":"/2017/2017-08-21-Providing_static_files_in_your_Django_app_with_Amazon_S3/"},"timeToRead":5}},"pageContext":{"id":"ef7a27dd-994f-5a60-97c8-d32fe794b32d","language":"en","intl":{"language":"en","languages":["en","pt"],"messages":{"of":"of","or":"or","Next":"Next","Previous":"Previous","reading":"reading","Comments":"Comments","Featured_image_credits":"Featured image credits","Not_Found":"Not Found","Not_Found_Text":"The page you are looking for might have been removed, had its name changed or is temporarily unavailable.","Not_Found_Nav":"You can go to","Warning_deprecated":"Attention: this post was written some time ago and may not be valid anymore, ok?"},"routed":true,"originalPath":"/blog/2017/2017-08-21-Providing_static_files_in_your_Django_app_with_Amazon_S3/","redirect":true,"defaultLanguage":"en"}}},"staticQueryHashes":["2841359383"]}